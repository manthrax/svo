<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title>SVO on Box (Three.js) â€” DataTexture + MagicaVoxel</title>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <style>
            html,body {
                height: 100%;
                margin: 0;
                background: #111;
                color: #ddd;
                font: 14px/1.3 system-ui
            }
            select,option{
                background: #111;
                color: #ddd;
                
            }

            canvas {
                display: block;
                width: 100%;
                height: 100%;
                position: absolute;
                left: 0px;
                top: 0px;
            }

            .ui {
                position: fixed;
                left: 8px;
                top: 8px;
                right: 8px;
                display: flex;
                gap: 8px;
                align-items: center;
                z-index: 10
            }

            .ui>* {
                background: #1e1e1e;
                border: 1px solid #333;
                border-radius: 6px;
                padding: 6px 10px
            }

            .spacer {
                flex: 1
            }

            input[type=file] {
                padding: 4px 8px
            }

            .btn {
                cursor: pointer
            }

            .stat {
                opacity: .8
            }
        </style>
        <script type='importmap'>
            {
                "imports": {
                    "three": "https://cdn.jsdelivr.net/npm/three@0.164/build/three.module.js",
                    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.164/examples/jsm/"
                }
            }</script>
    </head>
    <body>
        <div class="ui">
            <select id="fileSelect"></select>
            <input id="file" type="file" accept=".vox"/>
            <label class="stat" id="stat">Load a .vox (MagicaVoxel) file or enjoy the demo sphere.</label>
            <span class="spacer"></span>
            <label>
                LOD px <input id="lodpx" type="range" min="0" max="4" step="0.25" value="0">
            </label>
        </div>
        <script type="module">
            import *as SVO from "./svo5.js"
            import * as GV from "./greedyVox.js"
            import*as THREE from 'three';
            import {parseVOX} from "./vox-loader.js"
            import {OrbitControls} from 'three/addons/controls/OrbitControls.js';

            // ----- Renderer / Scene -----
            const renderer = new THREE.WebGLRenderer({
                //antialias: true,
                alpha: true
            });
            renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);
            const scene = new THREE.Scene();
            renderer.setClearColor( 'lightblue' )
            const camera = new THREE.PerspectiveCamera(55,1,0.01,1000);
            camera.position.set(0, 5, -6);
            const controls = new OrbitControls(camera,renderer.domElement);

            const geo = new THREE.BoxGeometry(1,1,1);


            // Optional: log the expanded shaders to verify injected uniforms
            /*SVO.mat.onBeforeCompile = (shader) => {
                console.log('%c[three] Final Vertex Shader', 'color:#8cf');
                console.log(shader.vertexShader);
                console.log('%c[three] Final Fragment Shader', 'color:#8cf');
                console.log(shader.fragmentShader);
            }
            ;*/

            const mesh = new THREE.Mesh(geo,SVO.mat);
            mesh.position.x = -1.2;
            scene.add(mesh);
            let gMesh = null;

            // extra object behind to test occlusion
            const light = new THREE.DirectionalLight(0xffffff,1);
            light.position.set(3, 3, 5);
            scene.add(light);
            let ambi = new THREE.AmbientLight('red',.1);
            scene.add(ambi)
            const ball = new THREE.Mesh(new THREE.SphereGeometry(.5,32,16),new THREE.MeshStandardMaterial({
                color: 0x88aaff
            }));
            scene.add(ball);
            ball.onBeforeRender = () => {
                ball.position.x = Math.sin(performance.now() / 10000) * 10;
            }
            ;

            let tmat = new THREE.MeshStandardMaterial();
            tmat.onBeforeCompile = SVO.injectShader;
            
            // clones
            let d=1;
            for (let i = 0; i < d*d; i++) {
                let x= i%d;
                let y= (i/d)|0
                const m = new THREE.Mesh(geo,SVO.mat);
                m.position.x += x * 1.2;
                m.position.z += y * 1.2;
                m.rotation.x = -Math.PI*.5
                m.rotation.z = -Math.PI
                scene.add(m);
            }

            // ----- UI -----
            const stat = document.getElementById('stat');
            const file = document.getElementById('file');
            let loadVOXFile = async (f)=>{

                const {dense, size, palette} = await parseVOX(await f.arrayBuffer());
                const palTex = SVO.makePaletteTexture(palette);
                SVO.ensurePalette(palTex);
                GV.ensurePalette(palTex);
                SVO.uploadSVO(SVO.buildSVOFromDense(dense, size, renderer.capabilities.maxTextureSize));
                GV.uploadVoxels(dense, size);
                if (gMesh) scene.remove(gMesh);
                gMesh = GV.makeMesh(dense, size);
                gMesh.rotation.x = -Math.PI*.5
                gMesh.position.x = .0;
                gMesh.position.z = .0;
                scene.add(gMesh);
            }
            file.addEventListener('change', async (e) => {
                const f = e.target.files[0];
                if (!f)
                    return;
                stat.textContent = 'Parsing ' + f.name + '...';
                try {
                    await loadVOXFile(f)
                    stat.textContent = `Loaded ${f.name} : ${size}^3, nodes tex ${SVO.uSvoTex.image.width}x${SVO.uSvoTex.image.height}`;
                } catch (err) {
                    console.error(err);
                    stat.textContent = 'Error: ' + err.message;
                }
            }
            );

            let voxes = await(await fetch("assets/voxes.txt")).text()
            voxes.split("\n").forEach(url=>{
                let opt = document.createElement('option')
                opt.text=opt.value = url;
                window.fileSelect.appendChild(opt)
            })
            window.fileSelect.onchange=async (e)=>{
                console.log("loading:",e.target.value)
                loadVOXFile(await fetch('./assets/vox/'+e.target.value));
            }

            loadVOXFile(await fetch('./assets/vox/monu10.vox'));
            
            const lodpx = document.getElementById('lodpx');
            lodpx.addEventListener('input', () => {
                SVO.mat.uniforms.uLodPx.value = parseFloat(lodpx.value);
            }
            );


            // ----- Resize / render -----
            function onResize() {
                const w = innerWidth
                  , h = innerHeight;
                renderer.setSize(w, h, false);
                camera.aspect = w / h;
                camera.updateProjectionMatrix();
                SVO.mat.uniforms.iResolution.value.set(w, h);
            }
            addEventListener('resize', onResize);
            onResize();
            const clock = new THREE.Clock();
            renderer.setAnimationLoop( () => {
                SVO.mat.uniforms.iTime.value = clock.getElapsedTime();
                controls.update();
                renderer.render(scene, camera);
            }
            );



        </script>
    </body>
</html>
